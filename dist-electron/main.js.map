{"version":3,"file":"main.js","sources":["../src/main/onion/install/downloader.ts","../src/main/onion/install/verify.ts","../src/main/onion/install/unpack.ts","../src/main/onion/pinnedHashes.ts","../src/main/onion/componentRegistry.ts","../src/main/onion/install/swapperRollback.ts","../src/main/onion/errors.ts","../src/main/onion/assetNaming.ts","../src/main/onion/install/installTor.ts","../src/main/onion/install/installLokinet.ts","../src/main/onion/runtime/torManager.ts","../src/main/onion/runtime/lokinetManager.ts","../src/main/onion/runtime/onionRuntime.ts","../src/main/onion/update/checkUpdates.ts","../src/main.ts"],"sourcesContent":["import fs from \"node:fs\";\nimport https from \"node:https\";\nimport type { IncomingMessage } from \"node:http\";\nimport { pipeline } from \"node:stream/promises\";\nimport { URL } from \"node:url\";\n\r\nexport type DownloadProgress = {\r\n  receivedBytes: number;\r\n  totalBytes: number;\r\n};\r\n\r\nconst getResponse = async (url: string, redirects = 0): Promise<IncomingMessage> => {\n  if (redirects > 5) {\n    throw new Error(\"Too many redirects\");\n  }\n  const response = await new Promise<IncomingMessage>((resolve, reject) => {\n    const req = https.get(\n      url,\n      { headers: { \"User-Agent\": \"nkc-onion-installer\" } },\n      (res) => resolve(res)\n    );\n    req.on(\"error\", reject);\n  });\n  if (response.statusCode && [301, 302, 307, 308].includes(response.statusCode)) {\n    const redirect = response.headers.location;\n    response.resume();\n    if (!redirect) {\n      throw new Error(\"Redirect missing location header\");\n    }\n    const nextUrl = new URL(redirect, url).toString();\n    return getResponse(nextUrl, redirects + 1);\n  }\n  if (response.statusCode && response.statusCode >= 400) {\n    const status = response.statusCode;\n    const statusMessage = response.statusMessage ?? \"\";\n    const error = new Error(`Download failed: ${status} ${statusMessage}`.trim());\n    (error as { details?: Record<string, unknown> }).details = {\n      url,\n      status,\n      statusMessage,\n    };\n    throw error;\n  }\n  return response;\n};\n\r\nexport const downloadFile = async (\r\n  url: string,\r\n  dest: string,\r\n  onProgress?: (progress: DownloadProgress) => void\r\n) => {\r\n  const request = await getResponse(url);\r\n\r\n  const totalBytes = Number(request.headers[\"content-length\"] ?? 0);\r\n  let receivedBytes = 0;\r\n  request.on(\"data\", (chunk: Buffer) => {\r\n    receivedBytes += chunk.length;\r\n    onProgress?.({ receivedBytes, totalBytes });\r\n  });\r\n\r\n  await pipeline(request, fs.createWriteStream(dest));\r\n};\r\n","import crypto from \"node:crypto\";\r\nimport fs from \"node:fs\";\r\n\r\nconst hashFile = async (filePath: string) => {\r\n  const hash = crypto.createHash(\"sha256\");\r\n  const stream = fs.createReadStream(filePath);\r\n  return new Promise<string>((resolve, reject) => {\r\n    stream.on(\"data\", (chunk) => hash.update(chunk));\r\n    stream.on(\"error\", reject);\r\n    stream.on(\"end\", () => resolve(hash.digest(\"hex\")));\r\n  });\r\n};\r\n\r\nexport const verifySha256 = async (filePath: string, expectedSha256: string) => {\r\n  const actual = await hashFile(filePath);\r\n  if (actual.toLowerCase() !== expectedSha256.toLowerCase()) {\r\n    const error = new Error(\r\n      `SHA256 mismatch (expected=${expectedSha256.toLowerCase()}, actual=${actual.toLowerCase()})`\r\n    );\r\n    (error as { expected?: string; actual?: string }).expected = expectedSha256;\r\n    (error as { expected?: string; actual?: string }).actual = actual;\r\n    throw error;\r\n  }\r\n};\r\n","import { execFile } from \"node:child_process\";\n\nexport const unpackArchive = async (archivePath: string, destDir: string) => {\n  const lowerPath = archivePath.toLowerCase();\n  const run = async (cmd: string, args: string[]) => {\n    return new Promise<void>((resolve, reject) => {\n      execFile(cmd, args, { windowsHide: true }, (error, stdout, stderr) => {\n        if (!error) {\n          resolve();\n          return;\n        }\n        const wrapped = new Error(\n          `${error.message}\\ncmd=${cmd} ${args.join(\" \")}\\n${stderr || stdout || \"\"}`.trim()\n        );\n        (wrapped as { details?: Record<string, unknown> }).details = {\n          cmd,\n          args,\n          stderr: stderr?.toString?.() ?? String(stderr ?? \"\"),\n          stdout: stdout?.toString?.() ?? String(stdout ?? \"\"),\n          code: (error as unknown as { code?: string }).code,\n        };\n        reject(wrapped);\n      });\n    });\n  };\n\n  if (lowerPath.endsWith(\".zip\")) {\n    if (process.platform === \"win32\") {\n      await run(\"powershell\", [\n        \"-NoProfile\",\n        \"-Command\",\n        `Expand-Archive -Force -Path '${archivePath}' -DestinationPath '${destDir}'`,\n      ]);\n      return;\n    }\n    await run(\"unzip\", [\"-o\", archivePath, \"-d\", destDir]);\n    return;\n  }\n  if (\n    lowerPath.endsWith(\".tar.gz\") ||\n    lowerPath.endsWith(\".tgz\") ||\n    lowerPath.endsWith(\".tar.xz\")\n  ) {\n    await run(process.platform === \"win32\" ? \"tar.exe\" : \"tar\", [\n      \"-xf\",\n      archivePath,\n      \"-C\",\n      destDir,\n    ]);\n    return;\n  }\n  throw new Error(\"Unsupported archive format\");\n};\n","export type PinnedKeyParts = {\r\n  platform: NodeJS.Platform;\r\n  arch: NodeJS.Architecture;\r\n  version: string;\r\n  filename: string;\r\n};\r\n\r\nexport const makePinnedKey = (parts: PinnedKeyParts) =>\r\n  `${parts.platform}:${parts.arch}:${parts.version}:${parts.filename}`;\r\n\r\nexport const pinnedSha256 = {\r\n  tor: {\r\n    [makePinnedKey({ platform: \"android\", arch: \"arm64\", version: \"15.0.4\", filename: \"tor-expert-bundle-android-aarch64-15.0.4.tar.gz\" })]: \"b1582efca86db843bb4fa435edd766086a77334b32924a72686894212d5e5955\",\r\n    [makePinnedKey({ platform: \"android\", arch: \"arm\", version: \"15.0.4\", filename: \"tor-expert-bundle-android-armv7-15.0.4.tar.gz\" })]: \"fdb2d8ed01e40506f1518ef3e5f83a3d62e6f5ac0f8798917532798d6c05771f\",\r\n    [makePinnedKey({ platform: \"android\", arch: \"ia32\", version: \"15.0.4\", filename: \"tor-expert-bundle-android-x86-15.0.4.tar.gz\" })]: \"c92f7ffbf105e0ae195e28ac516648b54ba1323f24b47ae236a6d711c7daffe2\",\r\n    [makePinnedKey({ platform: \"android\", arch: \"x64\", version: \"15.0.4\", filename: \"tor-expert-bundle-android-x86_64-15.0.4.tar.gz\" })]: \"0adf0201950c02d36897569576eff37718d4afe1835052a3bc424b78be1a0605\",\r\n    [makePinnedKey({ platform: \"linux\", arch: \"ia32\", version: \"15.0.4\", filename: \"tor-expert-bundle-linux-i686-15.0.4.tar.gz\" })]: \"228d1a1ccd2683b8c6abc4fd701ebdc7b59254bae47b6acd253cb6aea9338a50\",\r\n    [makePinnedKey({ platform: \"linux\", arch: \"x64\", version: \"15.0.4\", filename: \"tor-expert-bundle-linux-x86_64-15.0.4.tar.gz\" })]: \"b9d0cbb76b2d8cca37313393b7b02a931e8b63d58aacbeed18b24d5cbb887fe8\",\r\n    [makePinnedKey({ platform: \"darwin\", arch: \"arm64\", version: \"15.0.4\", filename: \"tor-expert-bundle-macos-aarch64-15.0.4.tar.gz\" })]: \"8f0a9dc1020b2d7a89356a6aabefb95663614b132790ea484381ccb669e2d255\",\r\n    [makePinnedKey({ platform: \"darwin\", arch: \"x64\", version: \"15.0.4\", filename: \"tor-expert-bundle-macos-x86_64-15.0.4.tar.gz\" })]: \"1577938b499f46b8cdfa6643c4bb982309ee48fcaa08e3d32ac64e2dd8c16830\",\r\n    [makePinnedKey({ platform: \"win32\", arch: \"ia32\", version: \"15.0.4\", filename: \"tor-expert-bundle-windows-i686-15.0.4.tar.gz\" })]: \"f1da12f12f0b49ffbbbe99d7a1994b5f7f5e6ced33e4f41d3a520d0d9c445a21\",\r\n    [makePinnedKey({ platform: \"win32\", arch: \"x64\", version: \"15.0.4\", filename: \"tor-expert-bundle-windows-x86_64-15.0.4.tar.gz\" })]: \"cce12f8097b1657b56e22ec54cbed4b57fd5f8ff97cc426c21ebd5cc15173924\",\r\n  },\r\n  lokinet: {\n    [makePinnedKey({ platform: \"linux\", arch: \"x64\", version: \"0.9.14\", filename: \"lokinet-linux-amd64-v0.9.14.tar.xz\" })]: \"4097f96779a007abf35f37a46394eb5af39debd27244c190ce6867caf7a5115d\",\n    [makePinnedKey({ platform: \"win32\", arch: \"x64\", version: \"0.9.11\", filename: \"lokinet-0.9.11-win64.exe\" })]: \"0a4a972e1f2d7d2af7f6aebcd15953d98f4ff53b5e823a7d7aa2953eeea2c8d2\",\n  },\n} as const;\n","import path from \"node:path\";\r\nimport type { OnionNetwork } from \"../../net/netConfig\";\r\nimport { makePinnedKey, pinnedSha256 } from \"./pinnedHashes\";\r\n\r\nexport type ComponentDownload = {\r\n  version: string;\r\n  assetName: string;\r\n  url: string;\r\n  sha256: string;\r\n};\r\n\r\ntype ComponentRegistryEntry = {\r\n  id: OnionNetwork;\r\n  displayName: string;\r\n  binaryPath: (platform: NodeJS.Platform) => string;\r\n  pinnedSha256: Record<string, string>;\r\n};\r\n\r\nconst withExeSuffix = (platform: NodeJS.Platform, basename: string) =>\r\n  platform === \"win32\" ? `${basename}.exe` : basename;\r\n\r\nconst torEntry: ComponentRegistryEntry = {\r\n  id: \"tor\",\r\n  displayName: \"Tor\",\r\n  binaryPath: (platform) => path.join(\"Tor\", withExeSuffix(platform, \"tor\")),\r\n  pinnedSha256: pinnedSha256.tor,\r\n};\r\n\r\nconst lokinetEntry: ComponentRegistryEntry = {\r\n  id: \"lokinet\",\r\n  displayName: \"Lokinet\",\r\n  binaryPath: (platform) => withExeSuffix(platform, \"lokinet\"),\r\n  pinnedSha256: pinnedSha256.lokinet,\r\n};\r\n\r\nexport const componentRegistry: Record<OnionNetwork, ComponentRegistryEntry> = {\r\n  tor: torEntry,\r\n  lokinet: lokinetEntry,\r\n};\r\n\r\nexport const getBinaryPath = (network: OnionNetwork, platform: NodeJS.Platform = process.platform) =>\r\n  componentRegistry[network].binaryPath(platform);\r\n\r\nexport type PinnedHashLookup = {\r\n  platform?: NodeJS.Platform;\r\n  arch?: NodeJS.Architecture;\r\n  version: string;\r\n  assetName: string;\r\n};\r\n\r\nexport const getPinnedSha256 = (network: OnionNetwork, lookup: PinnedHashLookup) => {\r\n  const key = makePinnedKey({\r\n    platform: lookup.platform ?? process.platform,\r\n    arch: lookup.arch ?? process.arch,\r\n    version: lookup.version,\r\n    filename: lookup.assetName,\r\n  });\r\n  return componentRegistry[network].pinnedSha256[key];\r\n};\r\n","import fs from \"node:fs/promises\";\r\nimport path from \"node:path\";\r\nimport type { OnionNetwork } from \"../../../net/netConfig\";\r\n\r\ntype CurrentPointer = {\r\n  version: string;\r\n  path: string;\r\n};\r\n\r\nconst currentFileName = \"current.json\";\r\n\r\nconst getComponentRoot = (userDataDir: string, network: OnionNetwork) =>\r\n  path.join(userDataDir, \"onion\", \"components\", network);\r\n\r\nconst getPointerPath = (userDataDir: string, network: OnionNetwork) =>\r\n  path.join(getComponentRoot(userDataDir, network), currentFileName);\r\n\r\nconst writeJsonAtomic = async (filePath: string, data: CurrentPointer) => {\r\n  const tempPath = `${filePath}.tmp`;\r\n  await fs.mkdir(path.dirname(filePath), { recursive: true });\r\n  await fs.writeFile(tempPath, JSON.stringify(data, null, 2));\r\n  await fs.rename(tempPath, filePath);\r\n};\r\n\r\nexport const readCurrentPointer = async (userDataDir: string, network: OnionNetwork) => {\n  try {\n    const raw = await fs.readFile(getPointerPath(userDataDir, network), \"utf8\");\n    return JSON.parse(raw) as CurrentPointer;\n  } catch {\n    return null;\n  }\n};\n\r\nexport const swapWithRollback = async (\r\n  userDataDir: string,\r\n  network: OnionNetwork,\r\n  next: CurrentPointer\r\n) => {\r\n  const previous = await readCurrentPointer(userDataDir, network);\r\n  await writeJsonAtomic(getPointerPath(userDataDir, network), next);\r\n  return async () => {\r\n    if (previous) {\r\n      await writeJsonAtomic(getPointerPath(userDataDir, network), previous);\r\n    }\r\n  };\r\n};\r\n","export class PinnedHashMissingError extends Error {\r\n  readonly code = \"PINNED_HASH_MISSING\";\r\n  readonly details: string;\r\n\r\n  constructor(details: string) {\r\n    super(\"PINNED_HASH_MISSING\");\r\n    this.name = \"PinnedHashMissingError\";\r\n    this.details = details;\r\n  }\r\n}\r\n","const TOR_RELEASE_BASE = \"https://dist.torproject.org/torbrowser\";\r\nconst LOKINET_RELEASE_BASE = \"https://github.com/oxen-io/lokinet/releases/download\";\r\n\r\nconst getTorPlatformLabel = (platform: NodeJS.Platform) => {\r\n  switch (platform) {\r\n    case \"win32\":\r\n      return \"windows\";\r\n    case \"darwin\":\r\n      return \"macos\";\r\n    case \"linux\":\r\n      return \"linux\";\r\n    case \"android\":\r\n      return \"android\";\r\n    default:\r\n      return platform;\r\n  }\r\n};\r\n\r\nconst getTorArchLabel = (arch: NodeJS.Architecture) => {\r\n  switch (arch) {\r\n    case \"x64\":\r\n      return \"x86_64\";\r\n    case \"ia32\":\r\n      return \"i686\";\r\n    case \"arm64\":\r\n      return \"aarch64\";\r\n    case \"arm\":\r\n      return \"armv7\";\r\n    default:\r\n      return arch;\r\n  }\r\n};\r\n\r\nexport const getTorAssetName = (\r\n  version: string,\r\n  platform: NodeJS.Platform = process.platform,\r\n  arch: NodeJS.Architecture = process.arch\r\n) =>\r\n  `tor-expert-bundle-${getTorPlatformLabel(platform)}-${getTorArchLabel(arch)}-${version}.tar.gz`;\r\n\r\nexport const getTorAssetUrl = (\r\n  version: string,\r\n  platform: NodeJS.Platform = process.platform,\r\n  arch: NodeJS.Architecture = process.arch\r\n) => `${TOR_RELEASE_BASE}/${version}/${getTorAssetName(version, platform, arch)}`;\r\n\r\nconst getLokinetPlatformLabel = (platform: NodeJS.Platform) => {\r\n  switch (platform) {\r\n    case \"win32\":\r\n      return \"win32\";\r\n    case \"darwin\":\r\n      return \"macos\";\r\n    case \"linux\":\r\n      return \"linux\";\r\n    default:\r\n      return platform;\r\n  }\r\n};\r\n\r\nconst getLokinetArchLabel = (arch: NodeJS.Architecture) => {\r\n  switch (arch) {\r\n    case \"x64\":\r\n      return \"amd64\";\r\n    case \"ia32\":\r\n      return \"i686\";\r\n    case \"arm64\":\r\n      return \"arm64\";\r\n    default:\r\n      return arch;\r\n  }\r\n};\r\n\r\nconst getLokinetAssetExtension = (platform: NodeJS.Platform) => {\r\n  switch (platform) {\r\n    case \"linux\":\r\n    case \"darwin\":\r\n      return \"tar.xz\";\r\n    default:\r\n      return \"zip\";\r\n  }\r\n};\r\n\r\nexport const getLokinetAssetName = (\r\n  version: string,\r\n  platform: NodeJS.Platform = process.platform,\r\n  arch: NodeJS.Architecture = process.arch\r\n) =>\r\n  `lokinet-${getLokinetPlatformLabel(platform)}-${getLokinetArchLabel(arch)}-v${version}.${getLokinetAssetExtension(\r\n    platform\r\n  )}`;\r\n\r\nexport const getLokinetAssetUrl = (\r\n  version: string,\r\n  platform: NodeJS.Platform = process.platform,\r\n  arch: NodeJS.Architecture = process.arch\r\n) => `${LOKINET_RELEASE_BASE}/v${version}/${getLokinetAssetName(version, platform, arch)}`;\r\n\r\nexport const getLokinetAssetUrlForName = (version: string, assetName: string) =>\r\n  `${LOKINET_RELEASE_BASE}/v${version}/${assetName}`;\r\n","import fs from \"node:fs/promises\";\r\nimport fsSync from \"node:fs\";\r\nimport path from \"node:path\";\r\nimport type { OnionNetwork } from \"../../../net/netConfig\";\r\nimport { downloadFile } from \"./downloader\";\r\nimport { verifySha256 } from \"./verify\";\r\nimport { unpackArchive } from \"./unpack\";\r\nimport { getBinaryPath, getPinnedSha256 } from \"../componentRegistry\";\r\nimport { swapWithRollback } from \"./swapperRollback\";\r\nimport { PinnedHashMissingError } from \"../errors\";\r\nimport { getTorAssetName, getTorAssetUrl } from \"../assetNaming\";\r\n\r\ntype InstallProgress = {\r\n  step: \"download\" | \"verify\" | \"unpack\" | \"activate\";\r\n  message?: string;\r\n  receivedBytes?: number;\r\n  totalBytes?: number;\r\n};\r\n\r\ntype InstallResult = {\r\n  version: string;\r\n  installPath: string;\r\n  rollback: () => Promise<void>;\r\n};\r\n\r\nconst resolveDownload = (version: string) => {\r\n  const assetName = getTorAssetName(version);\r\n  return {\r\n    assetName,\r\n    url: getTorAssetUrl(version),\r\n  };\r\n};\r\n\r\nexport const installTor = async (\r\n  userDataDir: string,\r\n  version: string,\r\n  onProgress?: (progress: InstallProgress) => void,\r\n  downloadUrl?: string,\r\n  assetNameOverride?: string\r\n): Promise<InstallResult> => {\r\n  const network: OnionNetwork = \"tor\";\r\n  const { assetName, url } = resolveDownload(version);\r\n  const resolvedAssetName = assetNameOverride ?? assetName;\r\n  const hash = getPinnedSha256(network, { version, assetName: resolvedAssetName });\r\n  if (!hash) {\r\n    throw new PinnedHashMissingError(\r\n      `Missing pinned hash for Tor asset ${resolvedAssetName} (${version}).`\r\n    );\r\n  }\r\n\r\n  const baseOnionDir = path.join(userDataDir, \"onion\");\r\n  await fs.mkdir(baseOnionDir, { recursive: true });\r\n  const tempDir = await fs.mkdtemp(path.join(baseOnionDir, \"tmp-\"));\n  const resolvedUrl = downloadUrl ?? url;\n  const archivePath = path.join(tempDir, resolvedAssetName);\n  const installPath = path.join(userDataDir, \"onion\", \"components\", network, version);\n  const details: Record<string, unknown> = {\r\n    network,\r\n    version,\r\n    assetName: resolvedAssetName,\r\n    downloadUrl: resolvedUrl,\r\n    archivePath,\r\n    installPath,\r\n  };\r\n\r\n  try {\n    onProgress?.({ step: \"download\", message: \"Downloading Tor\" });\n    await downloadFile(resolvedUrl, archivePath, (progress) =>\n      onProgress?.({ step: \"download\", ...progress })\n    );\n    const stat = await fs.stat(archivePath);\r\n    details.downloadBytes = stat.size;\r\n\r\n    onProgress?.({ step: \"verify\", message: \"Verifying Tor\" });\r\n    await verifySha256(archivePath, hash);\r\n    details.expectedSha256 = hash;\r\n\r\n    await fs.rm(installPath, { recursive: true, force: true });\r\n    await fs.mkdir(installPath, { recursive: true });\r\n    onProgress?.({ step: \"unpack\", message: \"Unpacking Tor\" });\r\n    await unpackArchive(archivePath, installPath);\r\n    const binaryPath = path.join(installPath, getBinaryPath(network));\r\n    details.binaryPath = binaryPath;\r\n    if (!fsSync.existsSync(binaryPath)) {\r\n      throw new Error(`BINARY_MISSING: ${binaryPath}`);\r\n    }\r\n\r\n    onProgress?.({ step: \"activate\", message: \"Activating Tor\" });\n    const rollback = await swapWithRollback(userDataDir, network, { version, path: installPath });\n    return { version, installPath, rollback };\n  } catch (error) {\n    if (error && typeof error === \"object\") {\r\n      const err = error as { expected?: string; actual?: string };\r\n      if (err.expected) details.expectedSha256 = err.expected;\r\n      if (err.actual) details.actualSha256 = err.actual;\r\n    }\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    console.error(\"[onion] Tor install failed\", { message, details });\r\n    const wrapped = new Error(`${message} | details=${JSON.stringify(details)}`);\n    (wrapped as { details?: Record<string, unknown> }).details = details;\n    throw wrapped;\n  } finally {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  }\n};\n","import fs from \"node:fs/promises\";\nimport fsSync from \"node:fs\";\nimport path from \"node:path\";\nimport { execFile } from \"node:child_process\";\nimport type { OnionNetwork } from \"../../../net/netConfig\";\nimport { downloadFile } from \"./downloader\";\nimport { verifySha256 } from \"./verify\";\nimport { unpackArchive } from \"./unpack\";\nimport { getBinaryPath, getPinnedSha256 } from \"../componentRegistry\";\nimport { swapWithRollback } from \"./swapperRollback\";\r\nimport { PinnedHashMissingError } from \"../errors\";\r\nimport { getLokinetAssetName, getLokinetAssetUrlForName } from \"../assetNaming\";\r\n\r\ntype InstallProgress = {\r\n  step: \"download\" | \"verify\" | \"unpack\" | \"activate\";\r\n  message?: string;\r\n  receivedBytes?: number;\r\n  totalBytes?: number;\r\n};\r\n\r\ntype InstallResult = {\n  version: string;\n  installPath: string;\n  rollback: () => Promise<void>;\n};\n\nconst runInstaller = async (filePath: string) => {\n  if (process.platform !== \"win32\") {\n    throw new Error(\"Installer execution is only supported on Windows\");\n  }\n  const escapedPath = filePath.replace(/'/g, \"''\");\n  const psCommand = `Start-Process -FilePath '${escapedPath}' -ArgumentList '/S' -Verb RunAs -Wait`;\n  await new Promise<void>((resolve, reject) => {\n    execFile(\n      \"powershell.exe\",\n      [\"-NoProfile\", \"-NonInteractive\", \"-Command\", psCommand],\n      { windowsHide: true },\n      (error, stdout, stderr) => {\n        if (error) {\n          const wrapped = new Error(\n            `${error.message}\\n${stderr || stdout || \"\"}`.trim()\n          );\n          (wrapped as { details?: Record<string, unknown> }).details = {\n            filePath,\n            stderr: stderr?.toString?.() ?? String(stderr ?? \"\"),\n            stdout: stdout?.toString?.() ?? String(stdout ?? \"\"),\n            code: (error as unknown as { code?: string }).code,\n          };\n          reject(wrapped);\n          return;\n        }\n        void stdout;\n        void stderr;\n        resolve();\n      }\n    );\n  });\n};\n\nconst findLokinetBinaryWin32 = async () => {\n  const candidates: string[] = [];\n  await new Promise<void>((resolve) => {\n    execFile(\"where.exe\", [\"lokinet.exe\"], { windowsHide: true }, (_error, stdout) => {\n      if (stdout) {\n        candidates.push(\n          ...stdout\n            .toString()\n            .split(/\\r?\\n/)\n            .map((line) => line.trim())\n            .filter(Boolean)\n        );\n      }\n      resolve();\n    });\n  });\n\n  candidates.push(\n    \"C:\\\\\\\\Program Files\\\\\\\\Lokinet\\\\\\\\lokinet.exe\",\n    \"C:\\\\\\\\Program Files (x86)\\\\\\\\Lokinet\\\\\\\\lokinet.exe\",\n    \"C:\\\\\\\\Program Files\\\\\\\\Lokinet\\\\\\\\lokinet\\\\\\\\lokinet.exe\",\n    \"C:\\\\\\\\Program Files (x86)\\\\\\\\Lokinet\\\\\\\\lokinet\\\\\\\\lokinet.exe\"\n  );\n\n  const ps = async (command: string) => {\n    return new Promise<string>((resolve) => {\n      execFile(\n        \"powershell.exe\",\n        [\"-NoProfile\", \"-NonInteractive\", \"-Command\", command],\n        { windowsHide: true },\n        (_error, stdout) => resolve((stdout ?? \"\").toString())\n      );\n    });\n  };\n\n  // Registry install location (most reliable).\n  const installLocationsRaw = await ps(\n    \"$paths=@(); \" +\n      \"$roots=@('HKLM:\\\\\\\\Software\\\\\\\\Microsoft\\\\\\\\Windows\\\\\\\\CurrentVersion\\\\\\\\Uninstall\\\\\\\\*','HKLM:\\\\\\\\Software\\\\\\\\WOW6432Node\\\\\\\\Microsoft\\\\\\\\Windows\\\\\\\\CurrentVersion\\\\\\\\Uninstall\\\\\\\\*'); \" +\n      \"foreach($r in $roots){ \" +\n      \"  Get-ItemProperty $r -ErrorAction SilentlyContinue | \" +\n      \"    Where-Object { $_.DisplayName -match 'Lokinet' -or $_.DisplayName -match 'lokinet' } | \" +\n      \"    ForEach-Object { if($_.InstallLocation){$paths+=$_.InstallLocation} } \" +\n      \"}; \" +\n      \"$paths | ForEach-Object { $_.Trim() } | Where-Object { $_ } | Select-Object -Unique | ForEach-Object { $_ }\"\n  );\n  for (const line of installLocationsRaw.split(/\\r?\\n/).map((l) => l.trim()).filter(Boolean)) {\n    candidates.push(path.join(line, \"lokinet.exe\"));\n    candidates.push(path.join(line, \"lokinet\", \"lokinet.exe\"));\n  }\n\n  // Service image path (fallback).\n  const servicePathRaw = await ps(\n    \"(Get-ItemProperty 'HKLM:\\\\\\\\SYSTEM\\\\\\\\CurrentControlSet\\\\\\\\Services\\\\\\\\lokinet' -ErrorAction SilentlyContinue).ImagePath\"\n  );\n  const servicePath = servicePathRaw.trim().replace(/^\"|\"$/g, \"\");\n  if (servicePath) {\n    // ImagePath may include args; take the exe portion.\n    const exePath = servicePath.split(/\\s+/)[0].replace(/^\"|\"$/g, \"\");\n    candidates.push(exePath);\n    candidates.push(path.join(path.dirname(exePath), \"lokinet.exe\"));\n  }\n\n  for (const file of candidates) {\n    if (fsSync.existsSync(file)) {\n      return { binaryPath: file, baseDir: path.dirname(file) };\n    }\n  }\n  return null;\n};\n\nconst resolveDownload = (version: string, assetNameOverride?: string) => {\n  const assetName = assetNameOverride ?? getLokinetAssetName(version);\n  return {\n    assetName,\n    url: getLokinetAssetUrlForName(version, assetName),\r\n  };\r\n};\r\n\r\nexport const installLokinet = async (\n  userDataDir: string,\n  version: string,\n  onProgress?: (progress: InstallProgress) => void,\n  downloadUrl?: string,\n  assetNameOverride?: string\n): Promise<InstallResult> => {\n  const network: OnionNetwork = \"lokinet\";\n  const { assetName, url } = resolveDownload(version, assetNameOverride);\n  const hash = getPinnedSha256(network, { version, assetName });\n  if (!hash) {\n    throw new PinnedHashMissingError(\n      `Missing pinned hash for Lokinet asset ${assetName} (${version}).`\n    );\n  }\n\n  const baseOnionDir = path.join(userDataDir, \"onion\");\n  await fs.mkdir(baseOnionDir, { recursive: true });\n  const tempDir = await fs.mkdtemp(path.join(baseOnionDir, \"tmp-\"));\n  const resolvedUrl = downloadUrl ?? url;\n  const archivePath = path.join(tempDir, assetName);\n  const installPath = path.join(userDataDir, \"onion\", \"components\", network, version);\n  const details: Record<string, unknown> = {\n    network,\n    version,\n    assetName,\n    downloadUrl: resolvedUrl,\n    archivePath,\n    installPath,\n  };\n  onProgress?.({ step: \"download\", message: \"Downloading Lokinet\" });\n  try {\n    await downloadFile(resolvedUrl, archivePath, (progress) =>\n      onProgress?.({ step: \"download\", ...progress })\n    );\n    const stat = await fs.stat(archivePath);\n    details.downloadBytes = stat.size;\n\n    onProgress?.({ step: \"verify\", message: \"Verifying Lokinet\" });\n    await verifySha256(archivePath, hash);\n    details.expectedSha256 = hash;\n\n    if (process.platform === \"win32\" && assetName.toLowerCase().endsWith(\".exe\")) {\n      onProgress?.({ step: \"activate\", message: \"Installing Lokinet (requires admin)\" });\n      await runInstaller(archivePath);\n      const found = await findLokinetBinaryWin32();\n      if (!found) {\n        throw new Error(\"BINARY_MISSING: lokinet.exe not found after installer\");\n      }\n      details.binaryPath = found.binaryPath;\n      const rollback = await swapWithRollback(userDataDir, network, {\n        version,\n        path: found.baseDir,\n      });\n      return { version, installPath: found.baseDir, rollback };\n    }\n\n    await fs.rm(installPath, { recursive: true, force: true });\n    await fs.mkdir(installPath, { recursive: true });\n    onProgress?.({ step: \"unpack\", message: \"Unpacking Lokinet\" });\n    await unpackArchive(archivePath, installPath);\n    const binaryPath = path.join(installPath, getBinaryPath(network));\n    details.binaryPath = binaryPath;\n    if (!fsSync.existsSync(binaryPath)) {\n      throw new Error(`BINARY_MISSING: ${binaryPath}`);\n    }\n    onProgress?.({ step: \"activate\", message: \"Activating Lokinet\" });\n    const rollback = await swapWithRollback(userDataDir, network, { version, path: installPath });\n    return { version, installPath, rollback };\n  } catch (error) {\n    if (error && typeof error === \"object\") {\n      const err = error as { expected?: string; actual?: string };\n      if (err.expected) details.expectedSha256 = err.expected;\n      if (err.actual) details.actualSha256 = err.actual;\n    }\n    const message = error instanceof Error ? error.message : String(error);\n    console.error(\"[onion] Lokinet install failed\", { message, details });\n    const wrapped = new Error(`${message} | details=${JSON.stringify(details)}`);\n    (wrapped as { details?: Record<string, unknown> }).details = details;\n    throw wrapped;\n  } finally {\n    await fs.rm(tempDir, { recursive: true, force: true });\n  }\n};\n","import { spawn } from \"node:child_process\";\r\nimport type { ChildProcess } from \"node:child_process\";\r\n\r\ntype TorManagerState = {\r\n  running: boolean;\r\n  pid?: number;\r\n};\r\n\r\nexport class TorManager {\r\n  private process: ChildProcess | null = null;\r\n  private state: TorManagerState = { running: false };\r\n\r\n  async start(binaryPath: string, socksPort: number, dataDir: string) {\r\n    if (this.process) return;\r\n    const args = [\"--SocksPort\", `127.0.0.1:${socksPort}`, \"--DataDirectory\", dataDir];\r\n    this.process = spawn(binaryPath, args, { stdio: \"ignore\" });\r\n    this.state = { running: true, pid: this.process.pid };\r\n    this.process.on(\"exit\", () => {\r\n      this.state = { running: false };\r\n      this.process = null;\r\n    });\r\n  }\r\n\r\n  async stop() {\r\n    if (!this.process) return;\r\n    this.process.kill();\r\n    this.process = null;\r\n    this.state = { running: false };\r\n  }\r\n\r\n  getState() {\r\n    return this.state;\r\n  }\r\n}\r\n","import { spawn } from \"node:child_process\";\r\nimport type { ChildProcess } from \"node:child_process\";\r\n\r\ntype LokinetManagerState = {\r\n  running: boolean;\r\n  pid?: number;\r\n};\r\n\r\nexport class LokinetManager {\r\n  private process: ChildProcess | null = null;\r\n  private state: LokinetManagerState = { running: false };\r\n\r\n  async start(binaryPath: string, socksPort: number, dataDir: string) {\r\n    if (this.process) return;\r\n    const args = [\"--socks-port\", String(socksPort), \"--data-dir\", dataDir];\r\n    this.process = spawn(binaryPath, args, { stdio: \"ignore\" });\r\n    this.state = { running: true, pid: this.process.pid };\r\n    this.process.on(\"exit\", () => {\r\n      this.state = { running: false };\r\n      this.process = null;\r\n    });\r\n  }\r\n\r\n  async stop() {\r\n    if (!this.process) return;\r\n    this.process.kill();\r\n    this.process = null;\r\n    this.state = { running: false };\r\n  }\r\n\r\n  getState() {\r\n    return this.state;\r\n  }\r\n}\r\n","import net from \"node:net\";\r\nimport path from \"node:path\";\r\nimport fs from \"node:fs/promises\";\r\nimport fsSync from \"node:fs\";\r\nimport { session } from \"electron\";\r\nimport { getBinaryPath } from \"../componentRegistry\";\r\nimport type { OnionNetwork } from \"../../../net/netConfig\";\r\nimport { readCurrentPointer } from \"../install/swapperRollback\";\r\nimport { TorManager } from \"./torManager\";\r\nimport { LokinetManager } from \"./lokinetManager\";\r\n\r\ntype RuntimeStatus = {\r\n  status: \"idle\" | \"starting\" | \"running\" | \"failed\";\r\n  network?: OnionNetwork;\r\n  socksPort?: number;\r\n  error?: string;\r\n};\r\n\r\nconst PORT_START = 9050;\r\nconst PORT_END = 9070;\r\n\r\nconst findAvailablePort = async () => {\r\n  for (let port = PORT_START; port <= PORT_END; port += 1) {\r\n    const isFree = await new Promise<boolean>((resolve) => {\r\n      const server = net.createServer();\r\n      server.once(\"error\", () => resolve(false));\r\n      server.once(\"listening\", () => {\r\n        server.close(() => resolve(true));\r\n      });\r\n      server.listen(port, \"127.0.0.1\");\r\n    });\r\n    if (isFree) return port;\r\n  }\r\n  throw new Error(\"No available SOCKS port\");\r\n};\r\n\r\nconst waitForPort = async (port: number, timeoutMs = 30000) => {\r\n  const start = Date.now();\r\n  while (Date.now() - start < timeoutMs) {\r\n    const ok = await new Promise<boolean>((resolve) => {\r\n      const socket = net.createConnection({ host: \"127.0.0.1\", port }, () => {\r\n        socket.end();\r\n        resolve(true);\r\n      });\r\n      socket.on(\"error\", () => resolve(false));\r\n    });\r\n    if (ok) return;\r\n    await new Promise((resolve) => setTimeout(resolve, 250));\r\n  }\r\n  throw new Error(`SOCKS proxy not ready (port ${port})`);\r\n};\r\n\r\nexport class OnionRuntime {\r\n  private torManager = new TorManager();\r\n  private lokinetManager = new LokinetManager();\r\n  private status: RuntimeStatus = { status: \"idle\" };\r\n\r\n  async start(userDataDir: string, network: OnionNetwork) {\r\n    if (this.status.status === \"running\" && this.status.network === network) return;\r\n    await this.stop();\r\n    this.status = { status: \"starting\", network };\r\n    try {\r\n      const pointer = await readCurrentPointer(userDataDir, network);\r\n      if (!pointer) {\r\n        throw new Error(\"Component not installed\");\r\n      }\r\n\r\n      const port = await findAvailablePort();\r\n      const dataDir = path.join(userDataDir, \"onion\", \"runtime\", network);\r\n      await fs.mkdir(dataDir, { recursive: true });\r\n      const binaryPath = path.join(pointer.path, getBinaryPath(network));\r\n      if (!fsSync.existsSync(binaryPath)) {\r\n        throw new Error(`BINARY_MISSING: ${binaryPath}`);\r\n      }\r\n\r\n      if (network === \"tor\") {\r\n        await this.torManager.start(binaryPath, port, dataDir);\r\n      } else {\r\n        await this.lokinetManager.start(binaryPath, port, dataDir);\r\n      }\r\n\r\n      await waitForPort(port);\r\n      await session.defaultSession.setProxy({ proxyRules: `socks5://127.0.0.1:${port}` });\r\n      this.status = { status: \"running\", network, socksPort: port };\r\n    } catch (error) {\r\n      this.status = {\r\n        status: \"failed\",\r\n        network,\r\n        error: error instanceof Error ? error.message : String(error),\r\n      };\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async stop() {\r\n    await this.torManager.stop();\r\n    await this.lokinetManager.stop();\r\n    await session.defaultSession.setProxy({ mode: \"direct\" });\r\n    this.status = { status: \"idle\" };\r\n  }\r\n\r\n  getStatus() {\r\n    return {\r\n      ...this.status,\r\n      tor: this.torManager.getState(),\r\n      lokinet: this.lokinetManager.getState(),\r\n    };\r\n  }\r\n}\r\n","import https from \"node:https\";\r\nimport type { OnionNetwork } from \"../../../net/netConfig\";\r\nimport { getPinnedSha256 } from \"../componentRegistry\";\r\nimport { getTorAssetName, getTorAssetUrl } from \"../assetNaming\";\r\n\r\ntype ReleaseAsset = {\r\n  name: string;\r\n  browser_download_url: string;\r\n};\r\n\r\ntype ReleaseResponse = {\r\n  tag_name: string;\r\n  assets: ReleaseAsset[];\r\n};\r\n\r\ntype UpdateCheckResult = {\n  version: string | null;\n  assetName: string | null;\n  downloadUrl: string | null;\n  sha256: string | null;\n  errorCode?: \"PINNED_HASH_MISSING\" | \"ASSET_NOT_FOUND\";\n};\n\r\nconst fetchJson = async <T,>(url: string): Promise<T> => {\r\n  return new Promise((resolve, reject) => {\r\n    https\r\n      .get(\r\n        url,\r\n        { headers: { \"User-Agent\": \"nkc-onion-updater\" } },\r\n        (res) => {\r\n          if (res.statusCode && res.statusCode >= 400) {\r\n            reject(new Error(`Update check failed: ${res.statusCode}`));\r\n            return;\r\n          }\r\n          let raw = \"\";\r\n          res.setEncoding(\"utf8\");\r\n          res.on(\"data\", (chunk) => {\r\n            raw += chunk;\r\n          });\r\n          res.on(\"end\", () => {\r\n            try {\r\n              resolve(JSON.parse(raw) as T);\r\n            } catch (error) {\r\n              reject(error);\r\n            }\r\n          });\r\n        }\r\n      )\r\n      .on(\"error\", reject);\r\n  });\r\n};\r\n\r\nconst fetchText = async (url: string): Promise<string> => {\r\n  return new Promise((resolve, reject) => {\r\n    https\r\n      .get(url, { headers: { \"User-Agent\": \"nkc-onion-updater\" } }, (res) => {\r\n        if (res.statusCode && res.statusCode >= 400) {\r\n          reject(new Error(`Update check failed: ${res.statusCode}`));\r\n          return;\r\n        }\r\n        let raw = \"\";\r\n        res.setEncoding(\"utf8\");\r\n        res.on(\"data\", (chunk) => {\r\n          raw += chunk;\r\n        });\r\n        res.on(\"end\", () => resolve(raw));\r\n      })\r\n      .on(\"error\", reject);\r\n  });\r\n};\r\n\r\nexport const compareVersions = (a: string, b: string) => {\r\n  const aParts = a.replace(/^v/i, \"\").split(\".\").map(Number);\r\n  const bParts = b.replace(/^v/i, \"\").split(\".\").map(Number);\r\n  const len = Math.max(aParts.length, bParts.length);\r\n  for (let i = 0; i < len; i += 1) {\r\n    const aVal = aParts[i] ?? 0;\r\n    const bVal = bParts[i] ?? 0;\r\n    if (aVal > bVal) return 1;\r\n    if (aVal < bVal) return -1;\r\n  }\r\n  return 0;\r\n};\r\n\r\nconst getPlatformMatchers = () => {\n  const platformMatchers: RegExp[] = [];\n  switch (process.platform) {\n    case \"win32\":\n      platformMatchers.push(/win32/i, /windows/i, /win/i);\n      break;\n    case \"darwin\":\n      platformMatchers.push(/macos/i, /darwin/i, /osx/i, /mac/i);\n      break;\n    case \"linux\":\n      platformMatchers.push(/linux/i);\r\n      break;\r\n    case \"android\":\r\n      platformMatchers.push(/android/i);\r\n      break;\r\n    default:\r\n      platformMatchers.push(new RegExp(process.platform, \"i\"));\r\n      break;\r\n  }\r\n\r\n  const archMatchers: RegExp[] = [];\n  switch (process.arch) {\n    case \"x64\":\n      archMatchers.push(/x86_64/i, /amd64/i, /win64/i, /64bit/i);\n      break;\n    case \"ia32\":\n      archMatchers.push(/i686/i, /x86(?!_64)/i, /win32/i, /32bit/i);\n      break;\n    case \"arm64\":\n      archMatchers.push(/arm64/i, /aarch64/i);\n      break;\n    case \"arm\":\r\n      archMatchers.push(/armv7/i, /arm(?!64)/i);\r\n      break;\r\n    default:\r\n      archMatchers.push(new RegExp(process.arch, \"i\"));\r\n      break;\r\n  }\r\n\r\n  return { platformMatchers, archMatchers };\n};\n\nconst selectReleaseAsset = (assets: ReleaseAsset[]) => {\n  const { platformMatchers, archMatchers } = getPlatformMatchers();\n  return assets.find((asset) => {\r\n    if (asset.name.endsWith(\".asc\") || asset.name.endsWith(\".sig\")) return false;\r\n    const platformMatch = platformMatchers.some((pattern) => pattern.test(asset.name));\r\n    const archMatch = archMatchers.some((pattern) => pattern.test(asset.name));\r\n    return platformMatch && archMatch;\r\n  });\n};\n\nconst fetchReleases = async () => {\n  const url = \"https://api.github.com/repos/oxen-io/lokinet/releases?per_page=20\";\n  return fetchJson<ReleaseResponse[]>(url);\n};\n\nconst checkTorUpdates = async (): Promise<UpdateCheckResult> => {\n  const indexHtml = await fetchText(\"https://dist.torproject.org/torbrowser/\");\r\n  const versions = Array.from(indexHtml.matchAll(/href=\"(\\d+\\.\\d+\\.\\d+)\\//g)).map(\r\n    (match) => match[1]\r\n  );\r\n  const latest = versions.sort(compareVersions).at(-1);\r\n  if (!latest) {\r\n    return { version: null, assetName: null, downloadUrl: null, sha256: null };\r\n  }\r\n  const assetName = getTorAssetName(latest);\r\n  const sha256 = getPinnedSha256(\"tor\", { version: latest, assetName });\r\n  if (!sha256) {\r\n    return {\r\n      version: latest,\r\n      assetName,\r\n      downloadUrl: getTorAssetUrl(latest),\r\n      sha256: null,\r\n      errorCode: \"PINNED_HASH_MISSING\",\r\n    };\r\n  }\r\n  return {\r\n    version: latest,\r\n    assetName,\r\n    downloadUrl: getTorAssetUrl(latest),\r\n    sha256,\r\n  };\r\n};\r\n\r\nconst checkLokinetUpdates = async (): Promise<UpdateCheckResult> => {\n  const url = \"https://api.github.com/repos/oxen-io/lokinet/releases/latest\";\n  const release = await fetchJson<ReleaseResponse>(url);\n  let version = release.tag_name.replace(/^v/i, \"\");\n  let asset = selectReleaseAsset(release.assets);\n\n  if (!asset && process.platform === \"win32\") {\n    const releases = await fetchReleases();\n    for (const candidate of releases) {\n      const candidateAsset = selectReleaseAsset(candidate.assets);\n      if (candidateAsset) {\n        const candidateVersion = candidate.tag_name.replace(/^v/i, \"\");\n        const sha256 = getPinnedSha256(\"lokinet\", {\n          version: candidateVersion,\n          assetName: candidateAsset.name,\n        });\n        if (!sha256) continue;\n        version = candidateVersion;\n        asset = candidateAsset;\n        break;\n      }\n    }\n  }\n  if (!asset) {\n    return {\n      version,\n      assetName: null,\n      downloadUrl: null,\n      sha256: null,\n      errorCode: \"ASSET_NOT_FOUND\",\n    };\n  }\n  const sha256 = getPinnedSha256(\"lokinet\", { version, assetName: asset.name });\r\n  if (!sha256) {\r\n    return {\r\n      version,\r\n      assetName: asset.name,\r\n      downloadUrl: asset.browser_download_url,\r\n      sha256: null,\r\n      errorCode: \"PINNED_HASH_MISSING\",\r\n    };\r\n  }\r\n  return {\r\n    version,\r\n    assetName: asset.name,\r\n    downloadUrl: asset.browser_download_url,\r\n    sha256,\r\n  };\r\n};\r\n\r\nexport const checkUpdates = async (network: OnionNetwork) => {\r\n  if (network === \"tor\") {\r\n    return checkTorUpdates();\r\n  }\r\n  return checkLokinetUpdates();\r\n};\r\n","import { app, BrowserWindow, ipcMain, net, safeStorage, session } from \"electron\";\nimport fs from \"node:fs/promises\";\r\nimport fsSync from \"node:fs\";\r\nimport path from \"node:path\";\r\nimport type { OnionComponentState, OnionNetwork } from \"./net/netConfig\";\r\nimport { installTor } from \"./main/onion/install/installTor\";\r\nimport { installLokinet } from \"./main/onion/install/installLokinet\";\r\nimport { readCurrentPointer } from \"./main/onion/install/swapperRollback\";\r\nimport { OnionRuntime } from \"./main/onion/runtime/onionRuntime\";\r\nimport { checkUpdates } from \"./main/onion/update/checkUpdates\";\r\nimport { PinnedHashMissingError } from \"./main/onion/errors\";\r\n\r\ntype ProxyApplyPayload = {\r\n  proxyUrl: string;\r\n  enabled: boolean;\r\n  allowRemote: boolean;\r\n};\r\n\r\ntype ProxyHealth = {\r\n  ok: boolean;\r\n  message: string;\r\n};\r\n\r\nconst isDev = !app.isPackaged;\nconst SECRET_STORE_FILENAME = \"secret-store.json\";\nconst ALLOWED_PROXY_PROTOCOLS = new Set([\"socks5:\", \"socks5h:\", \"http:\", \"https:\"]);\n\nconst isLocalhostHost = (hostname: string) =>\n  hostname === \"127.0.0.1\" || hostname === \"localhost\" || hostname === \"::1\";\n\nconst validateProxyUrl = (input: string) => {\n  let url: URL;\n  try {\n    url = new URL(input.trim());\n  } catch {\n    throw new Error(\"Invalid proxy URL\");\n  }\n  if (!ALLOWED_PROXY_PROTOCOLS.has(url.protocol)) {\n    throw new Error(\"Invalid proxy URL\");\n  }\n  if (!url.hostname || !url.port) {\n    throw new Error(\"Invalid proxy URL\");\n  }\n  const port = Number(url.port);\n  if (!Number.isInteger(port) || port < 1 || port > 65535) {\n    throw new Error(\"Invalid proxy URL\");\n  }\n  return { url, normalized: `${url.protocol}//${url.host}` };\n};\n\nconst applyProxy = async ({ proxyUrl, enabled, allowRemote }: ProxyApplyPayload) => {\n  if (!enabled) {\n    await session.defaultSession.setProxy({ mode: \"direct\" });\n    return;\n  }\n  const { url, normalized } = validateProxyUrl(proxyUrl);\n  if (!allowRemote && !isLocalhostHost(url.hostname)) {\n    throw new Error(\"Remote proxy URL blocked\");\n  }\n  await session.defaultSession.setProxy({ proxyRules: normalized });\n};\n\r\nconst checkProxy = async (): Promise<ProxyHealth> => {\n  const resolve = await session.defaultSession.resolveProxy(\"https://example.com\");\n  const hasProxy = resolve.includes(\"PROXY\") || resolve.includes(\"SOCKS\");\n  if (!hasProxy) {\n    return { ok: false, message: \"proxy-not-applied\" };\n  }\n\r\n  return new Promise((resolvePromise) => {\r\n    const request = net.request(\"https://example.com\");\r\n    request.on(\"response\", () => resolvePromise({ ok: true, message: \"ok\" }));\r\n    request.on(\"error\", () => resolvePromise({ ok: false, message: \"unreachable\" }));\r\n    request.end();\r\n  });\r\n};\r\n\r\nexport const registerProxyIpc = () => {\n  ipcMain.handle(\"proxy:apply\", async (_event, payload: ProxyApplyPayload) => {\n    await applyProxy(payload);\n  });\n  ipcMain.handle(\"proxy:check\", async () => {\n    return checkProxy();\n  });\n};\n\nconst readSecretStore = async () => {\n  const filePath = path.join(app.getPath(\"userData\"), SECRET_STORE_FILENAME);\n  try {\n    const raw = await fs.readFile(filePath, \"utf8\");\n    const parsed = JSON.parse(raw) as Record<string, string>;\n    if (!parsed || typeof parsed !== \"object\") return {};\n    return parsed;\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error) {\n      const code = String((error as { code?: unknown }).code ?? \"\");\n      if (code === \"ENOENT\") return {};\n    }\n    return {};\n  }\n};\n\nconst writeSecretStore = async (payload: Record<string, string>) => {\n  const filePath = path.join(app.getPath(\"userData\"), SECRET_STORE_FILENAME);\n  await fs.writeFile(filePath, JSON.stringify(payload), \"utf8\");\n};\n\nconst registerSecretStoreIpc = () => {\n  ipcMain.handle(\"secretStore:get\", async (_event, key: string) => {\n    if (!safeStorage.isEncryptionAvailable()) {\n      return null;\n    }\n    const data = await readSecretStore();\n    const entry = data[key];\n    if (!entry) return null;\n    try {\n      return safeStorage.decryptString(Buffer.from(entry, \"base64\"));\n    } catch {\n      return null;\n    }\n  });\n\n  ipcMain.handle(\"secretStore:set\", async (_event, key: string, value: string) => {\n    if (!safeStorage.isEncryptionAvailable()) {\n      return false;\n    }\n    const data = await readSecretStore();\n    const encrypted = safeStorage.encryptString(value);\n    data[key] = encrypted.toString(\"base64\");\n    await writeSecretStore(data);\n    return true;\n  });\n\n  ipcMain.handle(\"secretStore:remove\", async (_event, key: string) => {\n    if (!safeStorage.isEncryptionAvailable()) {\n      return false;\n    }\n    const data = await readSecretStore();\n    if (key in data) {\n      delete data[key];\n      await writeSecretStore(data);\n    }\n    return true;\n  });\n\n  ipcMain.handle(\"secretStore:isAvailable\", async () => {\n    return safeStorage.isEncryptionAvailable();\n  });\n};\n\r\ntype OnionStatusPayload = {\r\n  components: {\r\n    tor: OnionComponentState;\r\n    lokinet: OnionComponentState;\r\n  };\r\n  runtime: ReturnType<OnionRuntime[\"getStatus\"]>;\r\n};\r\n\r\nconst onionRuntime = new OnionRuntime();\nconst onionComponentCache: Record<OnionNetwork, OnionComponentState> = {\n  tor: { installed: false, status: \"idle\" },\n  lokinet: { installed: false, status: \"idle\" },\n};\n\nconst pruneComponentVersions = async (\n  userDataDir: string,\n  network: OnionNetwork,\n  keep: { version: string; installPath: string }\n) => {\n  const componentsRoot = path.join(userDataDir, \"onion\", \"components\", network);\n  const normalizedRoot = path.resolve(componentsRoot) + path.sep;\n  const normalizedKeep = path.resolve(keep.installPath);\n  if (!normalizedKeep.startsWith(normalizedRoot)) return;\n\n  try {\n    const entries = await fs.readdir(componentsRoot, { withFileTypes: true });\n    await Promise.all(\n      entries\n        .filter((entry) => entry.isDirectory())\n        .map(async (entry) => {\n          if (entry.name === keep.version) return;\n          await fs.rm(path.join(componentsRoot, entry.name), { recursive: true, force: true });\n        })\n    );\n  } catch {\n    // Best-effort cleanup; ignore.\n  }\n};\n\nconst formatProgress = (receivedBytes?: number, totalBytes?: number) => {\n  if (!receivedBytes && !totalBytes) return \"\";\n  const total = totalBytes ?? 0;\n  if (total > 0) {\n    return `${Math.round((receivedBytes ?? 0) / 1024 / 1024)} / ${Math.round(total / 1024 / 1024)} MB`;\n  }\n  return `${Math.round((receivedBytes ?? 0) / 1024 / 1024)} MB`;\n};\n\r\nconst normalizeOnionError = (\n  error: unknown,\n  context: Record<string, unknown>\n) => {\n  const message = error instanceof Error ? error.message : String(error);\n  const errCode =\n    error && typeof error === \"object\" && \"code\" in error\n      ? String((error as { code?: unknown }).code ?? \"\")\n      : \"\";\n  const code =\n    error instanceof PinnedHashMissingError\n      ? \"PINNED_HASH_MISSING\"\n      : message.includes(\"SHA256 mismatch\")\n        ? \"HASH_MISMATCH\"\n        : message.includes(\"Download failed\") ||\r\n            message.includes(\"Too many redirects\") ||\r\n            message.includes(\"Redirect\")\r\n          ? \"DOWNLOAD_FAILED\"\r\n          : message.includes(\"Unsupported archive format\") ||\r\n              message.includes(\"tar\") ||\r\n              message.includes(\"unzip\") ||\r\n              message.includes(\"Expand-Archive\")\n            ? \"EXTRACT_FAILED\"\n            : message.includes(\"BINARY_MISSING\")\n              ? \"BINARY_MISSING\"\n              : (() => {\n                  const err = error as { code?: string };\n                  if (errCode === \"EACCES\" || errCode === \"EPERM\") return \"PERMISSION_DENIED\";\n                  if (err?.code === \"EACCES\" || err?.code === \"EPERM\") return \"PERMISSION_DENIED\";\n                  if (err?.code === \"ENOENT\") return \"FS_ERROR\";\n                  return \"UNKNOWN_ERROR\";\n                })();\n  const details =\r\n    error && typeof error === \"object\" && \"details\" in error\r\n      ? { ...context, ...(error as { details?: Record<string, unknown> }).details }\r\n      : context;\r\n  return { code, message, details };\r\n};\r\n\r\nconst refreshComponentState = async (userDataDir: string, network: OnionNetwork) => {\r\n  const pointer = await readCurrentPointer(userDataDir, network);\r\n  return {\r\n    ...onionComponentCache[network],\r\n    installed: Boolean(pointer),\r\n    version: pointer?.version,\r\n  };\r\n};\r\n\r\nconst emitOnionProgress = (\r\n  event: Electron.IpcMainInvokeEvent,\r\n  network: OnionNetwork,\r\n  status: OnionComponentState\r\n) => {\r\n  event.sender.send(\"onion:progress\", { network, status });\r\n};\r\n\r\nconst registerOnionIpc = () => {\r\n  ipcMain.handle(\"onion:status\", async () => {\r\n    const userDataDir = app.getPath(\"userData\");\r\n    return {\r\n      components: {\r\n        tor: await refreshComponentState(userDataDir, \"tor\"),\r\n        lokinet: await refreshComponentState(userDataDir, \"lokinet\"),\r\n      },\r\n      runtime: onionRuntime.getStatus(),\r\n    } satisfies OnionStatusPayload;\r\n  });\r\n\r\n  ipcMain.handle(\"onion:checkUpdates\", async () => {\n    const userDataDir = app.getPath(\"userData\");\r\n    const torUpdate = await checkUpdates(\"tor\");\r\n    const lokinetUpdate = await checkUpdates(\"lokinet\");\r\n    console.log(\"[onion] checkUpdates\", {\r\n      tor: {\r\n        version: torUpdate.version,\r\n        assetName: torUpdate.assetName,\r\n        downloadUrl: torUpdate.downloadUrl,\r\n        sha256: torUpdate.sha256 ? \"<present>\" : \"<missing>\",\r\n        errorCode: torUpdate.errorCode,\r\n      },\r\n      lokinet: {\r\n        version: lokinetUpdate.version,\r\n        assetName: lokinetUpdate.assetName,\r\n        downloadUrl: lokinetUpdate.downloadUrl,\r\n        sha256: lokinetUpdate.sha256 ? \"<present>\" : \"<missing>\",\r\n        errorCode: lokinetUpdate.errorCode,\r\n      },\r\n    });\r\n    const torState = await refreshComponentState(userDataDir, \"tor\");\r\n    const lokinetState = await refreshComponentState(userDataDir, \"lokinet\");\r\n    const torHasVerifiedUpdate =\r\n      Boolean(torUpdate.version && torUpdate.sha256 && torUpdate.downloadUrl);\r\n    const lokinetHasVerifiedUpdate =\r\n      Boolean(lokinetUpdate.version && lokinetUpdate.sha256 && lokinetUpdate.downloadUrl);\r\n    onionComponentCache.tor = {\n      ...torState,\n      latest: torHasVerifiedUpdate ? torUpdate.version ?? undefined : undefined,\n      error: torUpdate.errorCode === \"PINNED_HASH_MISSING\" ? \"PINNED_HASH_MISSING\" : undefined,\n      detail:\n        torUpdate.errorCode === \"PINNED_HASH_MISSING\"\n          ? `Pinned hash missing for ${torUpdate.assetName ?? torUpdate.version ?? \"unknown\"}`\n          : undefined,\n    };\n    onionComponentCache.lokinet = {\n      ...lokinetState,\n      latest: lokinetHasVerifiedUpdate ? lokinetUpdate.version ?? undefined : undefined,\n      error:\n        lokinetUpdate.errorCode === \"PINNED_HASH_MISSING\" ? \"PINNED_HASH_MISSING\" : undefined,\n      detail:\n        lokinetUpdate.errorCode === \"PINNED_HASH_MISSING\"\n          ? `Pinned hash missing for ${lokinetUpdate.assetName ?? lokinetUpdate.version ?? \"unknown\"}`\n          : undefined,\n    };\n    return {\r\n      components: {\r\n        tor: onionComponentCache.tor,\r\n        lokinet: onionComponentCache.lokinet,\r\n      },\r\n      runtime: onionRuntime.getStatus(),\r\n    } satisfies OnionStatusPayload;\r\n  });\r\n\r\n  ipcMain.handle(\"onion:install\", async (event, payload: { network: OnionNetwork }) => {\n    const userDataDir = app.getPath(\"userData\");\r\n    const network = payload.network;\r\n    let updates: Awaited<ReturnType<typeof checkUpdates>> | null = null;\r\n    try {\n      updates = await checkUpdates(network);\n      if (updates.errorCode === \"PINNED_HASH_MISSING\") {\n        throw new PinnedHashMissingError(\n          `Missing pinned hash for ${network} ${updates.assetName ?? updates.version ?? \"unknown\"}`\n        );\n      }\n      if (!updates.version || !updates.sha256 || !updates.downloadUrl || !updates.assetName) {\n        const err = new Error(\"No verified release available\");\n        (err as { details?: Record<string, unknown> }).details = {\n          network,\n          platform: process.platform,\n          arch: process.arch,\n          update: updates,\n        };\n        throw err;\n      }\n      onionComponentCache[network] = {\n        ...onionComponentCache[network],\n        status: \"downloading\",\n        error: undefined,\n        detail: \"Preparing download\",\n        progress: undefined,\n      };\n      emitOnionProgress(event, network, onionComponentCache[network]);\n      const install =\n        network === \"tor\"\n          ? installTor(\n              userDataDir,\n              updates.version,\n              (progress) => {\n                onionComponentCache[network] = {\n                  ...onionComponentCache[network],\n                  status: progress.step === \"download\" ? \"downloading\" : \"installing\",\n                  detail:\n                    (progress.message ?? \"\") +\n                    (progress.receivedBytes || progress.totalBytes\n                      ? ` (${formatProgress(progress.receivedBytes, progress.totalBytes)})`\n                      : \"\"),\n                  progress:\n                    progress.receivedBytes || progress.totalBytes\n                      ? {\n                          receivedBytes: progress.receivedBytes ?? 0,\n                          totalBytes: progress.totalBytes ?? 0,\n                        }\n                      : undefined,\n                };\n                emitOnionProgress(event, network, onionComponentCache[network]);\n              },\n              updates.downloadUrl ?? undefined,\n              updates.assetName ?? undefined\n            )\n          : installLokinet(\n              userDataDir,\n              updates.version,\n              (progress) => {\n                onionComponentCache[network] = {\n                  ...onionComponentCache[network],\n                  status: progress.step === \"download\" ? \"downloading\" : \"installing\",\n                  detail:\n                    (progress.message ?? \"\") +\n                    (progress.receivedBytes || progress.totalBytes\n                      ? ` (${formatProgress(progress.receivedBytes, progress.totalBytes)})`\n                      : \"\"),\n                  progress:\n                    progress.receivedBytes || progress.totalBytes\n                      ? {\n                          receivedBytes: progress.receivedBytes ?? 0,\n                          totalBytes: progress.totalBytes ?? 0,\n                        }\n                      : undefined,\n                };\n                emitOnionProgress(event, network, onionComponentCache[network]);\n              },\n              updates.downloadUrl ?? undefined,\n              updates.assetName ?? undefined\n            );\n      const result = await install;\n      onionComponentCache[network] = {\n        ...onionComponentCache[network],\n        installed: true,\n        status: \"ready\",\n        version: result.version,\n        error: undefined,\n        detail: `Installed ${result.version}`,\n        progress: undefined,\n      };\n      emitOnionProgress(event, network, onionComponentCache[network]);\n      await pruneComponentVersions(userDataDir, network, {\n        version: result.version,\n        installPath: result.installPath,\n      });\n    } catch (error) {\n      const context = {\n        network,\n        version: updates?.version,\n        assetName: updates?.assetName,\r\n        downloadUrl: updates?.downloadUrl,\r\n        targetDir:\r\n          updates?.version\r\n            ? path.join(userDataDir, \"onion\", \"components\", network, updates.version)\r\n            : undefined,\r\n      };\r\n      const normalized = normalizeOnionError(error, context);\r\n      console.error(\"Onion install failed\", {\r\n        code: normalized.code,\r\n        message: normalized.message,\r\n        details: normalized.details,\r\n      });\r\n      onionComponentCache[network] = {\n        ...onionComponentCache[network],\n        status: \"failed\",\n        error: `[${normalized.code}] ${normalized.message}`,\n        detail: JSON.stringify(normalized.details),\n        progress: undefined,\n      };\n      emitOnionProgress(event, network, onionComponentCache[network]);\n      const wrapped = new Error(`[${normalized.code}] ${normalized.message}`);\r\n      (wrapped as { code?: string; details?: Record<string, unknown> }).code = normalized.code;\r\n      (wrapped as { code?: string; details?: Record<string, unknown> }).details = normalized.details;\r\n      throw wrapped;\r\n    }\r\n  });\r\n\r\n  ipcMain.handle(\"onion:applyUpdate\", async (event, payload: { network: OnionNetwork }) => {\n    const network = payload.network;\r\n    const state = onionComponentCache[network];\r\n    if (!state.latest) {\r\n      throw new Error(\"No update available\");\r\n    }\r\n    const updateInfo = await checkUpdates(network);\r\n    if (updateInfo.errorCode === \"PINNED_HASH_MISSING\") {\r\n      throw new PinnedHashMissingError(\r\n        `Missing pinned hash for ${network} ${updateInfo.assetName ?? updateInfo.version ?? \"unknown\"}`\r\n      );\r\n    }\r\n    if (!updateInfo.version || !updateInfo.sha256 || !updateInfo.downloadUrl || !updateInfo.assetName) {\r\n      throw new Error(\"No verified release available\");\r\n    }\r\n    const updateVersion = updateInfo.version ?? state.latest;\r\n    if (!updateVersion) {\r\n      throw new Error(\"No verified release available\");\r\n    }\r\n    const userDataDir = app.getPath(\"userData\");\r\n    try {\n      const install =\n        network === \"tor\"\n          ? installTor(\n              userDataDir,\n              updateVersion,\n              (progress) => {\n                onionComponentCache[network] = {\n                  ...onionComponentCache[network],\n                  status: progress.step === \"download\" ? \"downloading\" : \"installing\",\n                  detail:\n                    (progress.message ?? \"\") +\n                    (progress.receivedBytes || progress.totalBytes\n                      ? ` (${formatProgress(progress.receivedBytes, progress.totalBytes)})`\n                      : \"\"),\n                  progress:\n                    progress.receivedBytes || progress.totalBytes\n                      ? {\n                          receivedBytes: progress.receivedBytes ?? 0,\n                          totalBytes: progress.totalBytes ?? 0,\n                        }\n                      : undefined,\n                };\n                emitOnionProgress(event, network, onionComponentCache[network]);\n              },\n              updateInfo.downloadUrl ?? undefined,\n              updateInfo.assetName ?? undefined\n            )\n          : installLokinet(\n              userDataDir,\n              updateVersion,\n              (progress) => {\n                onionComponentCache[network] = {\n                  ...onionComponentCache[network],\n                  status: progress.step === \"download\" ? \"downloading\" : \"installing\",\n                  detail:\n                    (progress.message ?? \"\") +\n                    (progress.receivedBytes || progress.totalBytes\n                      ? ` (${formatProgress(progress.receivedBytes, progress.totalBytes)})`\n                      : \"\"),\n                  progress:\n                    progress.receivedBytes || progress.totalBytes\n                      ? {\n                          receivedBytes: progress.receivedBytes ?? 0,\n                          totalBytes: progress.totalBytes ?? 0,\n                        }\n                      : undefined,\n                };\n                emitOnionProgress(event, network, onionComponentCache[network]);\n              },\n              updateInfo.downloadUrl ?? undefined,\n              updateInfo.assetName ?? undefined\n            );\n      const result = await install;\r\n      const runtime = onionRuntime.getStatus();\r\n      if (runtime.status === \"running\" && runtime.network === network) {\r\n        try {\r\n          await onionRuntime.start(userDataDir, network);\r\n        } catch (error) {\r\n          await result.rollback();\r\n          await onionRuntime.start(userDataDir, network);\r\n          throw error;\r\n        }\r\n      }\r\n      onionComponentCache[network] = {\n        ...onionComponentCache[network],\n        installed: true,\n        status: \"ready\",\n        version: result.version,\n        error: undefined,\n        detail: `Installed ${result.version}`,\n        progress: undefined,\n      };\n      emitOnionProgress(event, network, onionComponentCache[network]);\n      await pruneComponentVersions(userDataDir, network, {\n        version: result.version,\n        installPath: result.installPath,\n      });\n    } catch (error) {\n      const context = {\n        network,\n        version: updateVersion,\n        assetName: updateInfo.assetName,\r\n        downloadUrl: updateInfo.downloadUrl,\r\n        targetDir: path.join(userDataDir, \"onion\", \"components\", network, updateVersion),\r\n      };\r\n      const normalized = normalizeOnionError(error, context);\r\n      console.error(\"Onion update failed\", {\r\n        code: normalized.code,\r\n        message: normalized.message,\r\n        details: normalized.details,\r\n      });\r\n      onionComponentCache[network] = {\n        ...onionComponentCache[network],\n        status: \"failed\",\n        error: `[${normalized.code}] ${normalized.message}`,\n        detail: JSON.stringify(normalized.details),\n        progress: undefined,\n      };\n      emitOnionProgress(event, network, onionComponentCache[network]);\n      const wrapped = new Error(`[${normalized.code}] ${normalized.message}`);\r\n      (wrapped as { code?: string; details?: Record<string, unknown> }).code = normalized.code;\r\n      (wrapped as { code?: string; details?: Record<string, unknown> }).details = normalized.details;\r\n      throw wrapped;\r\n    }\r\n  });\r\n\r\n  ipcMain.handle(\"onion:uninstall\", async (_event, payload: { network: OnionNetwork }) => {\r\n    const network = payload.network;\r\n    await onionRuntime.stop();\r\n    const userDataDir = app.getPath(\"userData\");\r\n    const componentRoot = path.join(userDataDir, \"onion\", \"components\", network);\r\n    await fs.rm(componentRoot, { recursive: true, force: true });\r\n    onionComponentCache[network] = { installed: false, status: \"idle\" };\r\n  });\r\n\r\n  ipcMain.handle(\r\n    \"onion:setMode\",\r\n    async (_event, payload: { enabled: boolean; network: OnionNetwork }) => {\r\n      const userDataDir = app.getPath(\"userData\");\r\n      if (!payload.enabled) {\r\n        await onionRuntime.stop();\r\n        return;\r\n      }\r\n      await onionRuntime.start(userDataDir, payload.network);\r\n    }\r\n  );\r\n};\r\n\r\nconst rendererUrl = process.env.VITE_DEV_SERVER_URL;\r\nlet mainWindow: BrowserWindow | null = null;\r\n\r\nconst canReach = async (url: string, timeoutMs = 1200) =>\r\n  new Promise<boolean>((resolve) => {\r\n    try {\r\n      const request = net.request(url);\r\n    const timeout = setTimeout(() => {\n      try {\n        request.abort();\n      } catch {\n        // intentionally ignored\n      }\n      resolve(false);\n    }, timeoutMs);\n      request.on(\"response\", (response) => {\r\n        const ok = Boolean(response.statusCode && response.statusCode >= 200 && response.statusCode < 400);\r\n        response.on(\"data\", () => {});\r\n        response.on(\"end\", () => {\r\n          clearTimeout(timeout);\r\n          resolve(ok);\r\n        });\r\n      });\r\n      request.on(\"error\", () => {\r\n        clearTimeout(timeout);\r\n        resolve(false);\r\n      });\r\n      request.end();\r\n    } catch {\n      resolve(false);\n    }\n  });\n\r\nexport const createMainWindow = () => {\r\n  if (mainWindow && !mainWindow.isDestroyed()) {\r\n    mainWindow.show();\r\n    mainWindow.focus();\r\n    return mainWindow;\r\n  }\r\n  const preloadPath = path.join(__dirname, \"preload.js\");\r\n  const preloadExists = fsSync.existsSync(preloadPath);\r\n  if (isDev && !preloadExists) {\r\n    console.error(\"[dev] preload missing at\", preloadPath);\r\n  }\r\n  const sandboxEnabled = !(isDev && process.env.ELECTRON_DEV_NO_SANDBOX === \"1\");\r\n  const win = new BrowserWindow({\r\n    width: 1280,\r\n    height: 800,\r\n    webPreferences: {\r\n      preload: preloadExists ? preloadPath : undefined,\r\n      contextIsolation: true,\r\n      nodeIntegration: false,\r\n      sandbox: sandboxEnabled,\r\n      allowRunningInsecureContent: false,\r\n    },\r\n  });\r\n  win.webContents.on(\"did-fail-load\", (_event, errorCode, errorDesc, validatedURL) => {\r\n    console.error(\"[main] did-fail-load\", errorCode, errorDesc, validatedURL);\r\n  });\r\n  win.webContents.on(\"render-process-gone\", (_event, details) => {\r\n    console.error(\"[main] render-process-gone\", details);\r\n  });\r\n  win.webContents.on(\"unresponsive\", () => {\r\n    console.error(\"[main] renderer unresponsive\");\r\n  });\r\n  const safeLog = (...args: unknown[]) => {\r\n    if (!process.stdout || !process.stdout.writable) return;\r\n    try {\r\n      console.log(...args);\r\n    } catch (error) {\r\n      const message = error instanceof Error ? error.message : String(error);\r\n      const code =\r\n        error && typeof error === \"object\" && \"code\" in error\r\n          ? String((error as { code?: unknown }).code)\r\n          : \"\";\r\n      if (code === \"EPIPE\" || message.includes(\"EPIPE\")) {\r\n        return;\r\n      }\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const ignorePipeError = (error: unknown) => {\r\n    const message = error instanceof Error ? error.message : String(error);\r\n    const code =\r\n      error && typeof error === \"object\" && \"code\" in error\r\n        ? String((error as { code?: unknown }).code)\r\n        : \"\";\r\n    if (code === \"EPIPE\" || message.includes(\"EPIPE\")) {\r\n      return;\r\n    }\r\n    throw error;\r\n  };\r\n\r\n  process.stdout?.on(\"error\", ignorePipeError);\r\n  process.stderr?.on(\"error\", ignorePipeError);\r\n\r\n  if (isDev) {\r\n    win.webContents.on(\"console-message\", (_event, level, message, line, sourceId) => {\r\n      if (win.webContents.isDestroyed()) return;\r\n      safeLog(\"[renderer]\", level, message, sourceId, line);\r\n    });\r\n  }\r\n\r\n  const loadRenderer = async () => {\r\n    if (rendererUrl) {\r\n      console.log(\"[dev] rendererUrl =\", rendererUrl);\r\n      const ok = await canReach(rendererUrl);\r\n      if (ok) {\r\n        console.log(\"[dev] loadURL =\", rendererUrl);\r\n        void win.loadURL(rendererUrl);\r\n        return;\r\n      }\r\n      console.error(\"[dev] vite not reachable\", rendererUrl);\r\n    }\r\n    if (isDev) {\r\n      const fallbackUrl = \"http://localhost:5173/\";\r\n      const ok = await canReach(fallbackUrl);\r\n      if (ok) {\r\n        console.log(\"[dev] loadURL =\", fallbackUrl);\r\n        void win.loadURL(fallbackUrl);\r\n        return;\r\n      }\r\n      const distIndex = path.join(__dirname, \"../dist/index.html\");\r\n      if (fsSync.existsSync(distIndex)) {\r\n        console.log(\"[dev] loadFile =\", distIndex);\r\n        void win.loadFile(distIndex);\r\n        return;\r\n      }\r\n      const html = `<!doctype html><html><head><meta charset=\"utf-8\" /><title>Dev Server Unavailable</title></head><body style=\"font-family:sans-serif;padding:16px;\"><h2>Dev server not reachable</h2><p>Start Vite on http://localhost:5173 and reload.</p></body></html>`;\r\n      console.log(\"[dev] loadURL = dev fallback page\");\r\n      void win.loadURL(`data:text/html;charset=utf-8,${encodeURIComponent(html)}`);\r\n      return;\r\n    }\r\n    void win.loadFile(path.join(__dirname, \"../dist/index.html\"));\r\n  };\r\n  void loadRenderer();\r\n  if (process.env.OPEN_DEV_TOOLS) {\r\n    win.webContents.openDevTools({ mode: \"detach\" });\r\n  }\r\n  mainWindow = win;\r\n  win.on(\"closed\", () => {\r\n    mainWindow = null;\r\n  });\r\n  return win;\r\n};\r\n\r\nconst gotTheLock = app.requestSingleInstanceLock();\r\nif (!gotTheLock) {\r\n  app.quit();\r\n  process.exit(0);\r\n} else {\r\n  app.on(\"second-instance\", () => {\r\n    if (mainWindow && !mainWindow.isDestroyed()) {\r\n      if (mainWindow.isMinimized()) mainWindow.restore();\r\n      mainWindow.show();\r\n      mainWindow.focus();\r\n      return;\r\n    }\r\n    createMainWindow();\r\n  });\r\n}\r\n\r\nif (process.env.VITE_DEV_SERVER_URL) {\n  const temp = app.getPath(\"temp\");\n  const devRoot = process.env.NKC_E2E_USER_DATA_DIR || path.join(temp, \"nkc-electron-dev\");\n  const devUserData = path.join(devRoot, \"userData\");\n  const devCache = path.join(devRoot, \"cache\");\n  const devSession = path.join(devRoot, \"sessionData\");\n  const devTemp = path.join(devRoot, \"temp\");\n  fsSync.mkdirSync(devRoot, { recursive: true });\n  fsSync.mkdirSync(devUserData, { recursive: true });\n  fsSync.mkdirSync(devCache, { recursive: true });\n  fsSync.mkdirSync(devSession, { recursive: true });\n  fsSync.mkdirSync(devTemp, { recursive: true });\n  app.setPath(\"userData\", devUserData);\r\n  app.setPath(\"sessionData\", devSession);\r\n  app.setPath(\"temp\", devTemp);\r\n  console.log(\"[dev] userData =\", app.getPath(\"userData\"), \"temp =\", app.getPath(\"temp\"));\r\n}\r\n\r\napp.whenReady().then(() => {\n  if (isDev) {\n    console.log(\"[main] VITE_DEV_SERVER_URL =\", process.env.VITE_DEV_SERVER_URL ?? \"\");\n  }\n  registerProxyIpc();\n  registerSecretStoreIpc();\n  registerOnionIpc();\n  createMainWindow();\n  app.on(\"activate\", () => {\r\n    if (BrowserWindow.getAllWindows().length === 0) {\r\n      createMainWindow();\r\n    }\r\n  });\r\n});\r\n\r\napp.on(\"before-quit\", () => console.log(\"[main] before-quit\"));\r\napp.on(\"will-quit\", () => console.log(\"[main] will-quit\"));\r\napp.on(\"quit\", (_event, code) => console.log(\"[main] quit\", code));\r\n\r\napp.on(\"window-all-closed\", () => {\r\n  if (process.platform !== \"darwin\") {\r\n    app.quit();\r\n  }\r\n});\r\n"],"names":["getResponse","url","redirects","response","resolve","reject","https","res","redirect","nextUrl","URL","status","statusMessage","error","downloadFile","dest","onProgress","request","totalBytes","receivedBytes","chunk","pipeline","fs","hashFile","filePath","hash","crypto","stream","verifySha256","expectedSha256","actual","unpackArchive","archivePath","destDir","lowerPath","run","cmd","args","execFile","stdout","stderr","wrapped","makePinnedKey","parts","pinnedSha256","withExeSuffix","platform","basename","torEntry","path","lokinetEntry","componentRegistry","getBinaryPath","network","getPinnedSha256","lookup","key","currentFileName","getComponentRoot","userDataDir","getPointerPath","writeJsonAtomic","data","tempPath","readCurrentPointer","raw","swapWithRollback","next","previous","PinnedHashMissingError","details","TOR_RELEASE_BASE","LOKINET_RELEASE_BASE","getTorPlatformLabel","getTorArchLabel","arch","getTorAssetName","version","getTorAssetUrl","getLokinetPlatformLabel","getLokinetArchLabel","getLokinetAssetExtension","getLokinetAssetName","getLokinetAssetUrlForName","assetName","resolveDownload","installTor","downloadUrl","assetNameOverride","resolvedAssetName","baseOnionDir","tempDir","resolvedUrl","installPath","progress","stat","binaryPath","fsSync","rollback","err","message","runInstaller","psCommand","findLokinetBinaryWin32","candidates","_error","line","ps","command","installLocationsRaw","l","servicePath","exePath","file","installLokinet","found","TorManager","socksPort","dataDir","spawn","LokinetManager","PORT_START","PORT_END","findAvailablePort","port","server","net","waitForPort","timeoutMs","start","socket","OnionRuntime","pointer","session","fetchJson","fetchText","compareVersions","a","b","aParts","bParts","len","i","aVal","bVal","getPlatformMatchers","platformMatchers","archMatchers","selectReleaseAsset","assets","asset","platformMatch","pattern","archMatch","fetchReleases","checkTorUpdates","indexHtml","latest","match","sha256","checkLokinetUpdates","release","releases","candidate","candidateAsset","candidateVersion","checkUpdates","isDev","app","SECRET_STORE_FILENAME","ALLOWED_PROXY_PROTOCOLS","isLocalhostHost","hostname","validateProxyUrl","input","applyProxy","proxyUrl","enabled","allowRemote","normalized","checkProxy","resolvePromise","registerProxyIpc","ipcMain","_event","payload","readSecretStore","parsed","writeSecretStore","registerSecretStoreIpc","safeStorage","entry","value","encrypted","onionRuntime","onionComponentCache","pruneComponentVersions","keep","componentsRoot","normalizedRoot","entries","formatProgress","total","normalizeOnionError","context","errCode","code","refreshComponentState","emitOnionProgress","event","registerOnionIpc","torUpdate","lokinetUpdate","torState","lokinetState","torHasVerifiedUpdate","lokinetHasVerifiedUpdate","updates","result","state","updateInfo","updateVersion","runtime","componentRoot","rendererUrl","mainWindow","canReach","timeout","ok","createMainWindow","preloadPath","preloadExists","sandboxEnabled","win","BrowserWindow","errorCode","errorDesc","validatedURL","safeLog","ignorePipeError","level","sourceId","fallbackUrl","distIndex","html","gotTheLock","temp","devRoot","devUserData","devCache","devSession","devTemp"],"mappings":"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"}